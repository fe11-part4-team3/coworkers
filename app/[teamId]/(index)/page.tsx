'use client';

import { useParams } from 'next/navigation';
import { useMutation, useQuery } from '@tanstack/react-query';

import Container from '@/components/layout/Container';
import useUser from '@/hooks/useUser';
import useGroup from '@/hooks/useGroup';
import {
  createTaskList,
  deleteTaskList,
  updateTaskList,
} from '@/service/taskList.api';
import useTaskLists from '@/hooks/useTaskLists';
import { getTasksInGroup } from '@/service/group.api';

import GroupHeader from './GroupHeader';
import GroupMemberList from './GroupMemberList';
import GroupTaskListWrapper from './GroupTaskListWrapper';
import {
  _CreateTaskListParams,
  _DeleteTaskListParams,
  _UpdateTaskListParams,
} from './TeamPage.type';
import GroupReport from './GroupReport';

export default function TeamPage() {
  useUser(true);
  const { teamId } = useParams();
  const { group, members, refetch } = useGroup(Number(teamId));
  const { taskLists, refetchById, removeById } = useTaskLists();

  const { data: tasks } = useQuery({
    queryKey: ['tasks', group?.id],
    queryFn: () => {
      return group
        ? getTasksInGroup({ id: group.id, date: new Date().toISOString() })
        : [];
    },
    initialData: [],
  });

  const { mutate: onCreate } = useMutation({
    mutationFn: (params: _CreateTaskListParams) => _createTaskList(params),
    onSuccess: () => refetch(),
    onError: (error) => alert(error),
  });
  const { mutate: onEdit } = useMutation({
    mutationFn: (params: _UpdateTaskListParams) => _updateTaskList(params),
    onSuccess: ({ id }) => refetchById(id),
    onError: (error) => alert(error),
  });
  const { mutate: onDelete } = useMutation({
    mutationFn: (params: _DeleteTaskListParams) => _deleteTaskList(params),
    onSuccess: ({ id }) => removeById(id),
    onError: (error) => alert(error),
  });

  const _createTaskList = (params: _CreateTaskListParams) => {
    if (!group) throw new Error('목록을 생성할 팀이 없습니다');
    return createTaskList({ groupId: group.id, ...params });
  };

  const _updateTaskList = (params: _UpdateTaskListParams) => {
    if (!group) throw new Error('수정할 목록의 팀이 없습니다');
    return updateTaskList({ groupId: group.id, ...params });
  };

  const _deleteTaskList = async (params: _DeleteTaskListParams) => {
    if (!group) throw new Error('삭제할 목록의 팀이 없습니다');
    return deleteTaskList({ groupId: group.id, ...params });
  };

  if (!group) return null;

  return (
    <Container>
      <div className="flex flex-col gap-pr-24 pt-pr-24">
        <GroupHeader name={group.name} />
        <GroupTaskListWrapper
          taskLists={taskLists}
          onCreate={onCreate}
          onEdit={onEdit}
          onDelete={onDelete}
        />
        <GroupReport tasks={tasks} taskLists={taskLists} />
        <GroupMemberList groupId={group.id} members={members} />
      </div>
    </Container>
  );
}

const mockTasks: ITask[] = [
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    commentCount: 0,
    date: '2025-01-31T09:00:00+09:00',
    deletedAt: null,
    description: '감자튀김',
    displayIndex: 0,
    doneAt: '2025-01-31T09:00:00+09:00',
    doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
    frequency: 'ONCE',
    id: 17515,
    name: 'test1',
    recurringId: 4386,
    updatedAt: '2025-01-31T09:00:00+09:00',
    writer: { id: 1319, image: null, nickname: 'test1' },
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
  {
    doneBy: {
      user: null,
    },
    writer: null,
    displayIndex: 0,
    commentCount: 0,
    deletedAt: null,
    recurringId: 0,
    frequency: 'DAILY',
    updatedAt: '2025-01-31T15:23:16.207Z',
    doneAt: null,
    date: '2025-01-31T15:23:16.207Z',
    description: 'string',
    name: 'string',
    id: 0,
  },
];
const mockTaskLists: ITaskList[] = [
  {
    id: 2944,
    name: '햄버거',
    createdAt: '2025-01-28T04:16:01+09:00',
    updatedAt: '2025-01-28T04:16:01+09:00',
    groupId: 1750,
    displayIndex: 0,
    tasks: [
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
    ],
  },
  {
    id: 2945,
    name: '음료수',
    createdAt: '2025-01-28T04:16:36+09:00',
    updatedAt: '2025-01-30T20:16:26+09:00',
    groupId: 1750,
    displayIndex: 0,
    tasks: [
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
    ],
  },
  {
    id: 2946,
    name: '사이드',
    createdAt: '2025-01-28T04:16:44+09:00',
    updatedAt: '2025-01-28T04:16:59+09:00',
    groupId: 1750,
    displayIndex: 2,
    tasks: [
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
    ],
  },
  {
    id: 2947,
    name: '디저트',
    createdAt: '2025-01-28T04:16:49+09:00',
    updatedAt: '2025-01-28T04:16:49+09:00',
    groupId: 1750,
    displayIndex: 3,
    tasks: [
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        doneBy: {
          user: null,
        },
        writer: null,
        displayIndex: 0,
        commentCount: 0,
        deletedAt: null,
        recurringId: 0,
        frequency: 'DAILY',
        updatedAt: '2025-01-31T15:23:16.207Z',
        doneAt: null,
        date: '2025-01-31T15:23:16.207Z',
        description: 'string',
        name: 'string',
        id: 0,
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
      {
        commentCount: 0,
        date: '2025-01-31T09:00:00+09:00',
        deletedAt: null,
        description: '감자튀김',
        displayIndex: 0,
        doneAt: '2025-01-31T09:00:00+09:00',
        doneBy: { user: { id: 1319, image: null, nickname: 'test1' } },
        frequency: 'ONCE',
        id: 17515,
        name: 'test1',
        recurringId: 4386,
        updatedAt: '2025-01-31T09:00:00+09:00',
        writer: { id: 1319, image: null, nickname: 'test1' },
      },
    ],
  },
];
